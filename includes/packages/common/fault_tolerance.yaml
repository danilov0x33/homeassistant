common_fault_tolerance_package:
  recorder:
    include:
      entities:
        - binary_sensor.main_control
        - switch.main_control_mode

  homeassistant:
    customize:
      automation.system_toggle_automation_control_mode:
        friendly_name: Изменить местер instance Home Assistant

      binary_sensor.main_control:
        friendly_name: Является ли текущий сервер мастером
      switch.main_control_mode:
        friendly_name: "Режим управления"

  mqtt:
    binary_sensor:
      - name: main_control
        state_topic: "custom/main_control/state"
        value_template: "{{ is_state('sensor.local_ip', value) }}"
        payload_on: "True"
        payload_off: "False"

  switch:
    - platform: template
      switches:
        main_control_mode:
          value_template: "{{  is_state('binary_sensor.main_control', 'on') }}"
          turn_on:
            service: mqtt.publish
            data_template:
              topic: "custom/main_control/state"
              payload_template: "{{ states('sensor.local_ip') }}"
              retain: true
          turn_off:
            service: mqtt.publish
            data_template:
              topic: "custom/main_control/state"
              payload_template: "{{ (['192.168.3.20', '192.168.3.68'] | reject('match', states('sensor.local_ip')) | list)[0] }}"
              retain: true
          icon_template: >-
            {% if is_state('switch.main_control_mode', 'on') %}
              mdi:server
            {% else %}
              mdi:server-off
            {% endif %}

  automation:
    - id: system_toggle_automation_control_mode
      alias: system_toggle_automation_control_mode
      variables:
        all_main_automations: >
          {{ states.automation | map(attribute='entity_id') | select('search', '_main$' ) | list }}
      trigger:
        - platform: state
          entity_id: binary_sensor.main_control
          from: "on"
          to: "off"
        - platform: state
          entity_id: binary_sensor.main_control
          from: "off"
          to: "on"
      action:
        - choose:
            - conditions:
                - condition: state
                  entity_id: binary_sensor.main_control
                  state: "on"
              sequence:
                - service: homeassistant.turn_on
                  target:
                    entity_id: "{{ all_main_automations }}"
          default:
            - service: homeassistant.turn_off
              target:
                entity_id: "{{ all_main_automations }}"
